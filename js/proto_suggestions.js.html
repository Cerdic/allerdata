#HTTP_HEADER{'Content-Type: application/x-javascript'}
/* --------------------------------- Produits associés aux RC ------------------------------------- */

var LISTE_DES_SUGGESTIONS = {
  
  grid : null,
  
  init : function(){},
  
  getPanel : function(){

    if (!this.grid) {
          
      var dsp_libelle = function (texte) {
        var temp = new Array(); 
        temp = texte.split('==>');
        var nom = temp[0],
          array_items_reactifs = temp[1];
        return "<div class='cell_mol outlineLink' onclick='CCD.outline_prod(" + array_items_reactifs + ",\"#9BA1CF\");return false;'>" + nom + '</div>';
      };
    
      var dsp_nb = function(nb){
        if(nb > 2){
          return "<div class='cell_mol' style='color:red;'>" + nb + '</span></div>';
        }else if(nb > 1){
           return "<div class='cell_mol' style='color:green;'>" + nb + '</span></div>';
         }
        return nb;
      };
      
      var dsp_toInfo = function(id_item) {
        var t = "<div class='cell_mol info_mol' id='info_mol_" + id_item + "' onclick='ZONES_SAISIE.popupProd(" + id_item + ")'></div>";
        return t;
      };

      var ds_s = new Ext.data.Store({
      proxy: new Ext.data.HttpProxy({url:'spip.php?page=liste_des_suggestions'}),
      reader: new Ext.data.JsonReader({
        root: 'liste_des_suggestions',
				id: 'id_mol'
        }, [
           {name: 'nom'},
           {name: 'nb'},
           {name: 'id_mol'}
        ])
      });
      
      // La grille proprement dite
      this.grid = new Ext.grid.GridPanel({
        store: ds_s,
        columns: [
          {id:'nom',header: SUGG_P, sortable: true, locked:false, dataIndex: 'nom', renderer: dsp_libelle},
          {header: SUGG_CARD, width: 18, sortable: true, locked:true, dataIndex: 'nb', renderer: dsp_nb},
          {header: ' ', width: 20, sortable: false, locked:true, dataIndex: 'id_mol',renderer: dsp_toInfo}
        ],
        autoExpandColumn:'nom',
        loadMask: {msg:LOAD_MASK},
        viewConfig: {
          forceFit: true
        },
        title: SUGG_GRID_TITLE
      })
              
    }
    
    return this.grid;
  },

  // La mise à jour se fait par json
  show_query : function() {
    var p1 = jQuery('#p1').val(),
      p2 = jQuery('#p2').val(), 
      p3 = jQuery('#p3').val(), 
      p4 = jQuery('#p4').val(), 
      p5 = jQuery('#p5').val(),
      ds_s = this.grid.getStore();
    ds_s.load({params:{'p1':p1,'p2':p2,'p3':p3,'p4':p4,'p5':p5},callback:dragdrop});
  }
};

function dragdrop(){
  	jQuery('.cell_mol').not('.info_mol').addClass('drag').draggable({
  			helper: 'clone',
  			appendTo: 'body',
  			effect: 'fade'
  	});
	jQuery('#div-s1,#div-s2,#div-s1,#div-s3,#div-s4,#div-s5').droppable({
			accept: '.cell_mol',
			activeClass: 'activedrop',
			hoverClass: 'hoverdrop',
			tolerance: 'touch',
			drop: function(ev, ui) {
				var q=jQuery(ui.draggable.element).text();
				var s=jQuery(this).attr('id');
				jQuery.get('spip.php',{page:'id_du_produit',query:q},function(data){
					lId=s.replace('div-s','prod_');
					jQuery('#'+lId).val(q);
					lId=s.replace('div-s','p');
					lVal=parseInt(data);
					jQuery('#'+lId).val(lVal);
					reload_penta();
				});
			}
		});
}

Ext.onReady(LISTE_DES_SUGGESTIONS.init, LISTE_DES_SUGGESTIONS);

