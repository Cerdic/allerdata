#HTTP_HEADER{'Content-Type: application/x-javascript'}
/**
 * Makes a ComboBox have a twin trigger that is used to clear the value from the field.
 * User listener 'clear' to do something.
 *
 * @author Michael Giddens & help from Animal, jSakalos, Jack
 * http://extjs.com/forum/showthread.php?p=76130
 *
 * @history 2007-10-21 jvs
 * Combobox Mod for Ext 2.0
 */
Ext.ux.TwinComboBox = Ext.extend(Ext.form.ComboBox, {
	initComponent : function(){
		Ext.form.TwinTriggerField.prototype.initComponent.call(this);
		this.on('specialkey', function(f, e){
			var k = e.getKey();
			if (k == e.ESC){
				if (this.lastSelectionText) {
					this.setRawValue(this.lastSelectionText);
				} else {
					this.clearValue();
					this.fireEvent('clear', this);
					Ext.form.TextField.prototype.preFocus.call(this);
				}
			}
			if (k == e.TAB){
				Ext.form.ComboBox.superclass.onBlur.call(this);
				if (!this.value)
					this.onTrigger1Click();
				else 
					reload_penta();
			}
		}, this);
  },
	getTrigger : Ext.form.TwinTriggerField.prototype.getTrigger,
	initTrigger : Ext.form.TwinTriggerField.prototype.initTrigger,
  trigger1Class : 'x-form-clear-trigger',
  hideTrigger1 : true,
	queryDelay : 10,
  reset : Ext.form.Field.prototype.reset.createSequence(function(){        
		this.triggers[0].hide();
		}),
  onViewClick :    Ext.form.ComboBox.prototype.onViewClick.createSequence(function(){
		this.triggers[0].show(); // Added to show trigger
		}),
  onTrigger2Click : function(){
		this.onTriggerClick();
		},
	onTrigger1Click : function(){
		this.clearValue();
		this.triggers[0].hide();
		this.fireEvent('clear', this);
		Ext.form.ComboBox.superclass.onBlur.call(this);
		reload_penta();
    },
  // Parametres supplementaires pour Allerdata
  displayField:'nom',                                   // ce qu'on affiche
  valueField:'id_item',                                 // la valeur qui sera envoyées
  forceSelection: true,                                 // obliger de ne saisir que ce qui est proposé
  typeAhead: false,                                     // suggestion
  hideTrigger2 : true,
  minChars:2,                                           // nb de caractères avant requete de suggestion
  grow:true,                                            // s'adapte au nb de résultats
  maxHeight:300,                                        // hauteur maxi
  selectOnFocus:true,                                   // pour éviter le pb du double-clic
  selectOnBlur:false,
	loadingText: COMBO_LOADINGTEXT,                       // -
  emptyText:COMBO_EMPTYTEXT,   			                    // -
  width: 186                                            // -
});


/* -------------------- Mise en avant de 2 produits et de leur lien ------------------------- */

var MiseEnAvant = function(){

    return {
      prod_1 : 0,
      prod_2 : 0,
      init : function(){
      for (i=1;i<5;i++) {
        for (j=i+1;j<=5;j++) {
          jQuery('#link_'+i+'-'+j).bind(
            'mousedown', function(e) {
              var id = jQuery(this).attr('id');
              var re = /link_(\d)-(\d)/;
              var found = id.match(re);
              var i = found[1];
              var j = found[2];
              jQuery('.actif').removeClass('actif');
              if (i!=MiseEnAvant.prod_1 || j!=MiseEnAvant.prod_2) {
                jQuery('#prod_'+i+', #prod_'+j+', #link_'+i+'-'+j).addClass('actif');
                MiseEnAvant.prod_1 = i;
                MiseEnAvant.prod_2 = j;                
              } else {
                MiseEnAvant.prod_1 = MiseEnAvant.prod_2 = 0;
              }
            }
          );
        }
      }
    }
  };
}();

Ext.EventManager.onDocumentReady(MiseEnAvant.init, MiseEnAvant, true);


/* ----------------------------- Nettoyage des comboBox ---------------------------------- */

// Permet de nettoyer proprement le combo lorsque le champ de saisie perd le focus
// Il faut nettoyer la valeur + afficher le texte par défaut + supprimer les divs de suggestion
// pour vraiment effacer une combo

Ext.form.ComboBox.prototype.doForce = function() {
    v = this.getValue() || '';
    if(isNaN(v) && (this.getValue() != $('#' + this.el.dom.id).val())) {
        this.clearValue();
        this.applyEmptyText();
    }
}

/* --------------------------------- Listes de saisie ------------------------------------- */

var ZONES_SAISIE = {
  
  combo_1 : null,
  combo_2 : null,
  combo_3 : null,
  combo_4 : null,
  combo_5 : null,
  
  init : function() {
    cstore = new Ext.data.JsonStore({
      url: 'spip.php?action=liste_des_produits',
      root: 'produits',
      fields : ['id_item','nom']
    });

    this.combo_1 = new Ext.ux.TwinComboBox({
		  store: cstore,						                             // d'où viennent les données
      applyTo:'prod_1',
			hiddenName:'p1'                                      // le champs cché qui permet d'envoyer la valeur (et pas le texte)
    });
    
    this.combo_1.on('clear',function(){
       $('#info-s1').hide();
       $('.concerne-p1').removeClass('rc_toujours');
       $('.concerne-p1').removeClass('rc_jamais');
       $('.concerne-p1').removeClass('rc_discordant');
       $('#liens_infos .concerne-p1').hide();
       }
    );
    this.combo_1.on('blur', function(){ this.doForce() });

 
    this.combo_2 = new Ext.ux.TwinComboBox({
		  store: cstore,						                             // d'où viennent les données
      applyTo:'prod_2',
      hiddenName : 'p2'
    });
    this.combo_2.on('clear',function(){
      $('#info-s2').hide();
      $('.concerne-p2').removeClass('rc_toujours');
      $('.concerne-p2').removeClass('rc_jamais');
      $('.concerne-p2').removeClass('rc_discordant');
      $('#liens_infos .concerne-p2').hide();
    }
    );
 
    this.combo_3 = new Ext.ux.TwinComboBox({
		  store: cstore,						                             // d'où viennent les données
      applyTo:'prod_3',
      hiddenName:'p3'
    });
    this.combo_3.on('clear',function(){
      $('#info-s3').hide();
      $('.concerne-p3').removeClass('rc_toujours');
      $('.concerne-p3').removeClass('rc_jamais');
      $('.concerne-p3').removeClass('rc_discordant');
      $('#liens_infos .concerne-p3').hide();
    });
  
    this.combo_4 = new Ext.ux.TwinComboBox({
		  store: cstore,						                             // d'où viennent les données
      applyTo:'prod_4',
      hiddenName:'p4'
    });
    this.combo_4.on('clear',function(){
      $('#info-s4').hide();
      $('.concerne-p4').removeClass('rc_toujours');
      $('.concerne-p4').removeClass('rc_jamais');
      $('.concerne-p4').removeClass('rc_discordant');
      $('#liens_infos .concerne-p4').hide();
  	});
  
    this.combo_5 = new Ext.ux.TwinComboBox({
		  store: cstore,						                             // d'où viennent les données
      applyTo:'prod_5',
      hiddenName:'p5'
    });
    this.combo_5.on('clear',function(){
      $('#info-s5').hide();
      $('.concerne-p5').removeClass('rc_toujours');
      $('.concerne-p5').removeClass('rc_jamais');
      $('.concerne-p5').removeClass('rc_discordant');
      $('#liens_infos .concerne-p5').hide();
  	});

    if ($('#p1').val()) $('#info-s1').show();
    if ($('#p2').val()) $('#info-s2').show();
    if ($('#p3').val()) $('#info-s3').show();
    if ($('#p4').val()) $('#info-s4').show();
    if ($('#p5').val()) $('#info-s5').show();
  },
  
  setValue : function (sobj,val){
    obj = Ext.get(sobj);
    obj.set({value:val});
  }
};
Ext.onReady(ZONES_SAISIE.init, ZONES_SAISIE);
